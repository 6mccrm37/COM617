<!DOCTYPE html>
<html>
<head>
  <title>Py6S Tableau WDC</title>
  <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.0.js"></script>
</head>
<body>
  <h2>Py6S Model Connector</h2>

  <label>Latitude:
    <input type="number" id="latitude" value="50" />
  </label>
  <br>
  <label>Date (YYYY-MM-DD):
    <input type="text" id="date" value="2024-07-14" />
  </label>
  <br>
  <label>AOT550 Values (comma-separated):
    <input type="text" id="aot550" value="0.1,0.5,1.0" />
  </label>
  <br>
  <label>Sensor:
    <select id="sensor">
      <option value="landsat_etm">Landsat ETM</option>
      <option value="vnir">VNIR</option>
    </select>
  </label>
  <br><br>

  <button onclick="submitForm()">Load Data in Tableau</button>

  <script>
    function submitForm() {
      const latitude = parseFloat(document.getElementById("latitude").value);
      const date = document.getElementById("date").value;
      const aot550_values = document.getElementById("aot550").value.split(',').map(Number);
      const sensor = document.getElementById("sensor").value;

      tableau.connectionData = JSON.stringify({
        latitude,
        date,
        aot550_values,
        sensor
      });

      tableau.connectionName = "Py6S Multi-AOT Connector";
      tableau.submit();
    }

    const myConnector = tableau.makeConnector();

    myConnector.getSchema = function (schemaCallback) {
      const cols = [
        { id: "wavelength", dataType: tableau.dataTypeEnum.float },
        { id: "radiance", dataType: tableau.dataTypeEnum.float },
        { id: "aot550", dataType: tableau.dataTypeEnum.float }
      ];

      schemaCallback([
        {
          id: "py6s_results",
          alias: "Radiance by Wavelength and AOT",
          columns: cols
        }
      ]);
    };

    myConnector.getData = function (table, doneCallback) {
      const data = JSON.parse(tableau.connectionData);

      fetch("http://localhost:8000/run-multi", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      })
        .then(res => res.json())
        .then(json => {
          table.appendRows(json.data);
          doneCallback();
        })
        .catch(err => {
          console.error("Fetch error:", err);
          tableau.abortWithError("Failed to fetch data.");
        });
    };

    tableau.registerConnector(myConnector);
  </script>
</body>
</html>
